name: E2E Tests

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:

jobs:
    e2e-test:
        runs-on: windows-latest

        steps:
            - uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Setup Rust
              uses: dtolnay/rust-action@stable

            - name: Cache Rust dependencies
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: apps/desktop/src-tauri

            - name: Install tauri-driver
              run: cargo install tauri-driver --locked

            # Download Edge driver matching the CI machine's Edge version
            - name: Install msedgedriver-tool
              run: cargo install --git https://github.com/chippers/msedgedriver-tool

            - name: Download matching Edge driver
              run: |
                  & "$env:USERPROFILE\.cargo\bin\msedgedriver-tool.exe"
                  Move-Item -Path "msedgedriver.exe" -Destination "$env:USERPROFILE\.cargo\bin\" -Force

            - name: Install dependencies
              run: bun install
              working-directory: apps/desktop

            - name: Install E2E test dependencies
              run: npm install
              working-directory: apps/desktop/e2e

            - name: Build Tauri app (debug)
              run: bun run tauri build --debug --no-bundle
              working-directory: apps/desktop

            - name: Run E2E tests
              run: npm test
              working-directory: apps/desktop/e2e
